<html>
	<head>
		<script src="https://cdn.firebase.com/js/client/1.0.6/firebase.js"></script>
		<script src="https://cdn.firebase.com/js/simple-login/1.2.5/firebase-simple-login.js"></script>
		<script>
		try {
			var firebase = new Firebase("https://trump.firebaseio.com/");
			var app_user;
		    var firebase = new Firebase("https://trump.firebaseio.com/");
            var auth = new FirebaseSimpleLogin(firebase, function (error, user) {
            	alert('we will try to auth from firebase now.');
              if (error) {
                // an error occurred while attempting login
                alert(error);
              } else if (user) {
                // user authenticated with Firebase
                app_user = user;
                
                var game_list = new Firebase('https://trump.firebaseio.com/users/' + app_user.id + '/games/');
	            game_list.on('value', function (gamedata) {
	                Ti.App.fireEvent('app:gameListChanged', { games: gamedata.val() });
	            });

                alert('Firebase User ID: ' + user.id + ', Provider: ' + user.provider);
              } else {
                alert('The user is logged out.')
              }
            });
            
            /* LISTEN FOR EVENTS */
            Ti.App.addEventListener('app:fbAuthed', function (e) {
            	Ti.API.info(e.access_token);
                auth.login('facebook', {
                    access_token: e.access_token
                });
            });
            
            Ti.App.addEventListener('app:createGame', function (event) {
				var adjective_list = new Firebase('https://trump.firebaseio.com/adjectives/');
				adjective_list.on('value', function (adjectives) {
					adjectives = adjectives.val();
					adjective_id = randInt(0, adjectives.length);
					selection = adjectives[adjective_id];
					Ti.API.info(selection['adjective'] + ': ' + selection['synonyms'].join(', '));
					
					var games = new Firebase('https://trump.firebaseio.com/games/');
					Ti.API.info(event.friends);
					
					var newPushRef = games.push();
					newPushRef.set({
						adjective: adjective_id,
						participants: event.friends
					});
					var pushedName = newPushRef.name();
					var friends = event.friends;
					
					for (var i = 0; i < friends.length; i++)
					{
						friend_games = new Firebase('https://trump.firebaseio.com/users/'+friends[i]+'/games/');
						friend_games.push(pushedName);
					}

				});
            });
            			
            /* FIRE EVENTS */
            
			Ti.App.fireEvent('app:webviewproxyDidLoad');
			
            /* UTILITIES */
			function randInt(min, max) {
				return Math.floor(Math.random() * (max - min + 1) + min);
			}
			
        }
        catch(e) {
            alert(e);
        }
		</script>
	</head>
	<body></body>
</html>