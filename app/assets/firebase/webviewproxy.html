<html>
	<head>
		<script src="https://cdn.firebase.com/js/client/1.0.6/firebase.js"></script>
		<script src="https://cdn.firebase.com/js/simple-login/1.2.5/firebase-simple-login.js"></script>
		<script>
		try{
		    
		    var firebase = new Firebase("https://trump.firebaseio.com/");
            var auth = new FirebaseSimpleLogin(firebase, function (error, user) {
                if (error) {
                    // an error occurred while attempting login
                    alert(error);
                } else if (user) {
                    // user authenticated with Firebase
                    alert('Firebase/Facebook User ID: ' + user.id + ', Provider: ' + user.provider);
                    alert(firebase.child("users"));
                    var firebase_users = new Firebase("https://trump.firebaseio.com/users");
                    firebase_users.once("value",function(children){
                        alert(children);
                        children_arr = children.val();
                        var child_exists = false;
                        alert(children_arr);
                        for(var key in children_arr)
                        {
                            if(children_arr[key].id == user.id) child_exists = true;
                        }
                        if(!child_exists)
                        {
                            firebase.child('users').push({id:user.id,total_score:0});                        
                        }
                    });
                } else {
                    // user is logged out
                }
            });
            
            /* LISTEN FOR EVENTS */
            Ti.App.addEventListener('app:fbAuthed', function (e) {
            	Ti.API.info(e.access_token);
                auth.login('facebook', {
                    access_token: e.access_token
                });
            });
            Ti.App.addEventListener("app:");
            
            Ti.App.addEventListener('app:createGame', function (event) {
				var adjective_list = new Firebase('https://trump.firebaseio.com/adjective_list/');
				adjective_list.on('value', function (adjectives) {
					adjectives = adjectives.val();
					adjective_id = randInt(0, adjectives.length);
					selection = adjectives[adjective_id];
					Ti.API.info(selection['adjective'] + ': ' + selection['synonyms'].join(', '));
					
					var games = new Firebase('https://trump.firebaseio.com/games/');
					Ti.API.info(event.friends);
					
					var newPushRef = games.push();
					newPushRef.set({
						adjective: adjective_id,
						participants: event.friends
					});
					var pushedName = newPushRef.name();
					var friends = event.friends;
					
					for (var i = 0; i < friends.length; i++)
					{
						friend_games = new Firebase('https://trump.firebaseio.com/users/'+friends[i]+'/games/');
						friend_games.push(pushedName);
					}

				});
            });
            			
            /* FIRE EVENTS */
            
			Ti.App.fireEvent('app:webviewproxyDidLoad');
			
            /* UTILITIES */
			function randInt(min, max) {
				return Math.floor(Math.random() * (max - min + 1) + min);
			}
			
        }
        catch(e) {
            alert(e);
        }
		</script>
	</head>
	<body></body>
</html>